<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="ESS PDF.js demo" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESS PDF.js Demo</title>
    <!-- pdf.js from CDN -->
    <script src="https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.js"></script>
    <!-- Optional local debug toggle. Create web/debug.js to enable logs (dev only).
      Use the helper script in example/flutter_web_demo/scripts/ to generate it. -->
    <script src="debug.js"></script>
    <script>
      // Configure worker (CDN)
      if (window.pdfjsLib) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.worker.js';
      }

      // Extraction helper that mirrors the repo root's web/pdf_extract.js
      window.extractPdfArrayBuffer = async function (arrayBuffer) {
        const pdfjs = window.pdfjsLib;
        if (!pdfjs) throw new Error('pdfjsLib not found');
        const uint8 = new Uint8Array(arrayBuffer);
        const loadingTask = pdfjs.getDocument({ data: uint8 });
        const pdf = await loadingTask.promise;
        const out = [];

        const columnHeaderRx = /\bPTS\b|\bTIME\b|\bFACTOR\b|\bPOINTS\b|\bPERCENT\b|\bName\b|\b#\b/i;
        const divisionRx = /^([A-Z\s&-]+)\s+--\s+Overall Stage Results/i;
        const stageRx = /Stage\s*(\d+|[A-Za-z0-9]+)/i;

        let currentDivision = '';
        let currentStage = '';

        for (let p = 1; p <= pdf.numPages; ++p) {
          const page = await pdf.getPage(p);
          const textContent = await page.getTextContent({disableCombineTextItems: false});
          const items = textContent.items.map(it => {
            const tr = it.transform || [0,0,0,0,0,0];
            return { x: tr[4] || 0, y: tr[5] || 0, str: it.str };
          });

          // Debugging: log per-page counts so we can see whether text items were found.
          // Debug logging (enable by setting window.__ESS_DEBUG__ = true in the page)
          try {
            if (window.__ESS_DEBUG__) console.log(`pdfjs: page ${p} text items: ${textContent.items.length}, mapped items: ${items.length}`);
          } catch (e) {
            // ignore logging errors
          }

          const groups = new Map();
          for (const it of items) {
            const key = String(Math.round(it.y));
            if (!groups.has(key)) groups.set(key, []);
            groups.get(key).push(it);
          }

          const ys = Array.from(groups.keys()).map(v => parseInt(v, 10)).sort((a,b)=>b-a);
          for (const y of ys) {
            const row = groups.get(String(y));
            row.sort((a,b)=>a.x-b.x);
            const line = row.map(i=>i.str).join(' ').replace(/\s+/g,' ').trim();
            if (!line) continue;

            const divMatch = line.match(divisionRx);
            if (divMatch) {
              currentDivision = divMatch[1].trim();
              out.push({ type: 'meta', meta: 'division', division: currentDivision, page: p });
              continue;
            }

            const sMatch = line.match(stageRx);
            if (sMatch) {
              currentStage = sMatch[0].trim();
              out.push({ type: 'meta', meta: 'stage', stage: currentStage, page: p });
              continue;
            }

            if (columnHeaderRx.test(line)) continue;
            if (/Overall Stage Results/i.test(line)) continue;

            out.push({ type: 'row', line: line, division: currentDivision, stage: currentStage, page: p });
          }
        }

        try {
          if (window.__ESS_DEBUG__) console.log('pdfjs: extraction complete, rows=', out.length);
        } catch (e) {}

        return out;
      };
    </script>
  </head>
  <body>
    <div id="app-status" style="position:fixed;top:8px;right:8px;background:rgba(255,255,255,0.95);color:#111;padding:6px;border:1px solid #ddd;border-radius:4px;z-index:9999;font-family:system-ui, -apple-system, Roboto, Arial, sans-serif;font-size:13px">Loading appâ€¦</div>
    <script>
      // Ensure the status box shows an initial message and log presence for debugging.
      document.addEventListener('DOMContentLoaded', function () {
          try {
            var s = document.getElementById('app-status');
            if (s) {
              s.textContent = 'index.html loaded';
              if (window.__ESS_DEBUG__) console.log('app-status element present');
            } else {
              if (window.__ESS_DEBUG__) console.warn('app-status element not found');
            }
          } catch (e) {
            if (window.__ESS_DEBUG__) console.error('Error setting app-status:', e);
          }
      });
    </script>
    <script src="main.dart.js"></script>
  </body>
</html>
